'use strict';

var React = require('react-native');
var deviceScreen = require('Dimensions').get('window');
var styles = require('./styles');
var queueAnimation = require('./animations');

var {
  PanResponder,
  View,
  TouchableOpacity
} = React;

var TimerMixin = require('react-timer-mixin');

/**
 * Default open menu offset. Describes a size of the amount you can
 * move content view from the left and release without opening it
 * @type {Number}
 */
var openMenuOffset = deviceScreen.width * 2 / 4;

/**
 * Content view offset in the `hidden` state
 * @type {Number}
 */
var hiddenMenuOffset = 0;

/**
 * Size of the amount you can move content view in the opened menu state and
 * release without menu closing
 * @type {Number}
 */
var barrierForward = deviceScreen.width / 4;

/**
 * Check if the current gesture offset bigger than allowed one
 * before opening menu
 * @param  {Number} dx Gesture offset from the left side of the window
 * @return {Boolean}
 */
function shouldOpenMenu(dx: Number) {
  return dx > barrierForward;
}

var SideMenu = React.createClass({
  /**
   * Current style `left` attribute
   * @todo Check if it's possible to avoid using `left`
   * @type {Number}
   */
  left: 0,

  /**
   * Default left offset for content view
   * @todo Check if it's possible to avoid using `prevLeft`
   * @type {Number}
   */
  prevLeft: 0,

  mixins: [TimerMixin],

  /**
   * Create pan responder before component render
   * @return {Void}
   */
  componentWillMount: function() {
    this.responder = PanResponder.create({
      onMoveShouldSetPanResponder: this.handleMoveShouldSetPanResponder,
      onPanResponderMove: this.handlePanResponderMove,
      onPanResponderRelease: this.handlePanResponderEnd,
    });
  },

  /**
   * Change `left` style attribute
   * Works only if `sideMenu` is a ref to React.Component
   * @return {Void}
   */
  updatePosition: function() {
    this.sideMenu.setNativeProps({ left: this.left });
    this.setState({left: this.left});
  },

  getInitialState: function() {
    return {
      left: 0,
      prevLeft: 0,
    }
  },

  responderCapture: function() {
      return true;
  },

  /**
    * Permission to use responder
   * @return {Boolean} true if it's a horizontal swipe.
    */
   handleMoveShouldSetPanResponder: function(e: Object, gestureState: Object) {
       // 如果不是首页则不触发侧边菜单
       if(global.routeIndex !== undefined) return false;
       var x = gestureState.dx;
       var y = gestureState.dy;
       if (x >= 3 && y <= 5) {
         return true;
       }
       return false;
  },

  /**
   * Handler on responder move
   * @param  {Synthetic Event} e
   * @param  {Object} gestureState
   * @return {Void}
   */
  handlePanResponderMove: function(e: Object, gestureState: Object) {
    this.left = this.prevLeft + gestureState.dx;

    if (this.left > 0) {
      this.updatePosition();
    }
  },

  /**
   * Open menu
   * @return {Void}
   */
  openMenu: function() {
    queueAnimation(this.props.animation);
    this.left = this.props.openMenuOffset || openMenuOffset;
    this.updatePosition();
    this.prevLeft = this.left;
  },

  /**
   * Close menu
   * @return {Void}
   */
  closeMenu: function() {
    queueAnimation(this.props.animation);
    this.left = this.props.hiddenMenuOffset || hiddenMenuOffset;
    this.updatePosition();
    this.prevLeft = this.left;
  },

  /**
   * Handler on responder move ending
   * @param  {Synthetic Event} e
   * @param  {Object} gestureState
   * @return {Void}
   */
  handlePanResponderEnd: function(e: Object, gestureState: Object) {
    if (shouldOpenMenu(this.left + gestureState.dx)) {
      this.openMenu();
    } else {
      this.closeMenu();
    }

    this.updatePosition();
    this.prevLeft = this.left;
  },

  /**
   * Get content view. This view will be rendered over menu
   * @return {React.Component}
   */
  getContentView: function() {

    console.log("sidemenu::" + global.routeIndex);
    // 窗口已经被弹开，此时禁用内容视图
    if(this.left > 100) {
      return (
          <View
            onStartShouldSetResponderCapture={()=>{
              this.closeMenu();
              return true;
            }}
            onResponderTerminationRequest={()=>{
              return true;
            }}
            onMoveShouldSetResponderCapture={()=>{
              return true;
            }}
            style={[styles.frontView, {opacity: 0.8}]}
            ref={(sideMenu) => this.sideMenu = sideMenu}>
              {this.props.children}
          </View>
        );
    // } else if(global.routeIndex !== undefined || global.routeIndex == 0) {
    //   return (
    //       <View
    //         style={styles.frontView}
    //         ref={(sideMenu) => this.sideMenu = sideMenu}>
    //           {this.props.children}
    //       </View>
    //   );
    }else {
      return (
          <View
            style={styles.frontView}
            ref={(sideMenu) => this.sideMenu = sideMenu}
            {...this.responder.panHandlers}>
              {this.props.children}
          </View>
      );
    }
  },

  /**
   * Get menu view. This view will be rendered under
   * content view. Also, this function will decorate
   * passed `menu` component with side menu API
   * @return {React.Component}
   */
  getMenuView: function() {
    var menuActions = {
      close: this.closeMenu,
    };

    return (
      <View style={styles.menu}>
        {React.addons.cloneWithProps(this.props.menu, { menuActions: menuActions, nav: this.props.nav, customAction: this.props.customAction })}
      </View>
    );
  },

  /**
   * Compose and render menu and content view
   * @return {React.Component}
   */
  render: function() {
    return (
      <View style={styles.container} onResponderTerminationRequest={()=>{return true}}>
        {this.getMenuView()}
        {this.getContentView()}
      </View>
    );
  }
});

module.exports = SideMenu;
